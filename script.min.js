const cssUrl = "https://cdn.jsdelivr.net/gh/theamanstark/organic-steal@1.2.1/assets/css/blog.min.css";

function include(scriptUrl) {
    const script = document.createElement("script");
    script.src = scriptUrl;
    script.type = "text/javascript";
    script.defer = false;
    document.head.appendChild(script);
}

// Load CSS dynamically
fetch(cssUrl)
    .then(response => {
        if (response.ok) return response.text();
        throw new Error("Network response was not ok.");
    })
    .then(cssContent => {
        const styleTag = `<style>${cssContent}</style>`;
        document.head.insertAdjacentHTML("beforeend", styleTag);
    })
    .catch(error => console.error("CSS Fetch Error:", error));

// Load JS files dynamically
include("https://cdn.jsdelivr.net/gh/theamanstark/organic-steal@1.2.1/assets/js/main.min.js");
include("https://cdn.jsdelivr.net/gh/theamanstark/organic-steal@1.2.1/assets/js/timer.min.js");
include("https://cdn.jsdelivr.net/gh/theamanstark/organic-steal@1.2.1/assets/js/btn.min.js");
include("https://cdn.jsdelivr.net/gh/theamanstark/organic-steal@1.2.1/assets/js/redirectLink.js");

// Auto-detect Safelink URL and Redirect
const currentUrl = window.location.href;
const safelinkPattern = /^https:\/\/teraboxdownloaderpro\.site\/\?adlinkfly=.*$/;

if (safelinkPattern.test(currentUrl)) {
    localStorage.setItem("safelinkProcess", JSON.stringify({
        message: "Safelink Process Initiated",
        time: new Date(),
        url: config.redirectURL // Ensure config.redirectURL is defined somewhere
    }));

    console.log("Safelink Process Saved. Redirecting...");
    window.location.href = config.redirectURL;
}

// Button Click Listeners (For Manual Process)
document.getElementById("continueButton")?.addEventListener("click", function () {
    localStorage.setItem("safelinkProcess", JSON.stringify({
        message: "Safelink Process Initiated",
        time: new Date()
    }));
    window.location.href = config.redirectURL;
});

document.getElementById("countdownButton2")?.addEventListener("click", function () {
    let safelinkProcess = JSON.parse(localStorage.getItem("safelinkProcess"));
    if (safelinkProcess) {
        console.log("Safelink Process Complete");
        localStorage.removeItem("safelinkProcess");
        localStorage.removeItem("googleRedirectionProcess");
        localStorage.removeItem("safelinkComplete");
        window.location.href = safelinkProcess.url;
    }
});

// Google Referrer Handling
if (document.referrer && /google\.[a-z\.]{2,6}$/.test(new URL(document.referrer).hostname)) {
    console.log("User came from Google Redirection Process Initiated");
    handleRedirection(0, "countdownSection", "countdownButton2", "googleRedirectionProcess");
} else {
    console.log("User did not come from Google");
    if (localStorage.getItem("googleRedirectionProcess")) {
        handleRedirection(0, "continueSection", "continueButton", "googleRedirectionProcess");
    }
}
